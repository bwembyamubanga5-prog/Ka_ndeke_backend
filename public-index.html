<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ka Ndeke ‚Äì Accounts & Crash Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* --- Layout & theme --- */
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#0b1c2d;
      color:#fff;
      text-align:center;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      background:#081421;
    }

    .header h2{margin:0;color:#f7c600}

    .header .auth button{
      margin-left:5px;
      padding:6px 10px;
    }

    .balance{
      padding:10px;
      font-size:18px;
      background:#081421;
    }

    .game{
      padding:10px;
      max-width:740px;
      margin:20px auto;
    }

    .sky{
      position:relative;
      height:280px;
      background:linear-gradient(#1e3c72,#2a5298);
      overflow:hidden;
      border-radius:10px;
    }

    #plane{
      position:absolute;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      font-size:40px;
    }

    #multiplier{
      position:absolute;
      top:10px;
      left:10px;
      font-size:22px;
      font-weight:bold;
    }

    .controls{
      margin-top:15px;
    }

    .controls input{
      padding:8px;
      width:140px;
    }

    .controls button{
      padding:8px 12px;
      margin:5px;
    }

    #status{
      margin-top:10px;
      font-weight:bold;
    }

    .demo{
      font-size:12px;
      opacity:0.8;
      margin-top:5px;
    }

    /* deposit/withdraw compact area */
    .wallet-controls {
      margin-top:8px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .wallet-controls input { width:140px; padding:6px; }

    /* simple modal for forms */
    .modal-backdrop {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
      z-index:1000;
    }
    .modal {
      background:#0b2035;
      padding:16px;
      border-radius:8px;
      width:320px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
      text-align:left;
    }
    .modal h3{margin-top:0;color:#f7c600}
    .modal label{display:block;margin-top:8px;font-size:14px}
    .modal input{width:100%;padding:8px;margin-top:4px;border-radius:4px;border:1px solid #234}
    .modal .row{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
    .small { font-size:12px; color:#bbb; margin-top:6px; display:block;}
    .error { color:#ff7b7b; margin-top:8px; font-size:13px;}
    .success { color:#7bffb6; margin-top:8px; font-size:13px;}
    @media (max-width:420px){ .modal{width:92%} .controls input{width:100px} .wallet-controls{flex-direction:column} }
  </style>
</head>
<body>
  <div class="header">
    <h2>‚úàÔ∏è Ka Ndeke</h2>
    <div class="auth">
      <button id="loginBtn">Login</button>
      <button id="registerBtn">Register</button>
      <button id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div>

  <div class="balance">
    Logged in as: <strong id="username">Guest</strong><br>
    Balance: <strong id="balance">K 0.00</strong><br>
    <small id="freeRounds"></small>
    <div class="wallet-controls" style="margin-top:8px;">
      <input type="number" id="depositAmount" placeholder="Deposit amount" />
      <button id="depositBtn">Deposit</button>
      <input type="number" id="withdrawAmount" placeholder="Withdraw amount" />
      <button id="withdrawBtn">Withdraw</button>
    </div>
    <div class="small">Deposits/withdrawals are persisted to your account on the server.</div>
  </div>

  <div class="game">
    <div class="sky">
      <div id="multiplier">1.00x</div>
      <div id="plane">‚úàÔ∏è</div>
    </div>

    <div class="controls">
      <input type="number" id="betAmount" placeholder="Bet (K)" />
      <br />
      <button id="betBtn">Place Bet</button>
      <button id="cashOutBtn" disabled>Cash Out</button>
    </div>

    <div id="status"></div>

    <div class="demo">Real accounts enabled ‚Äî register/login and deposit to test.</div>
  </div>

  <!-- Modal: Register / Login -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Login</h3>

      <form id="authForm">
        <div id="usernameRow" style="display:none;">
          <label for="modalUsername">Username</label>
          <input id="modalUsername" name="username" autocomplete="username" />
        </div>

        <label for="modalEmail">Email</label>
        <input id="modalEmail" name="email" type="email" autocomplete="email" />

        <label for="modalPassword">Password</label>
        <input id="modalPassword" name="password" type="password" autocomplete="current-password" />

        <div class="row">
          <button type="button" id="modalCancel">Cancel</button>
          <button type="submit" id="modalSubmit">Submit</button>
        </div>
        <div id="modalMessage" class=""></div>
      </form>
    </div>
  </div>

  <script>
    /* ---------------------------
       CONFIG: change if needed
       ---------------------------
       If you serve the frontend from a different origin than the backend
       set API_BASE to the full backend URL, e.g.:
         const API_BASE = 'http://localhost:3000/api';
       Otherwise '/api' works when backend serves the public folder.
    */
    const API_BASE = '/api';

    /* ---------------------------
       State & DOM refs
    */
    let balance = 0;
    let freePlays = 0;
    let currentUser = null; // user object when logged in
    let token = localStorage.getItem('token') || null;

    const usernameEl = document.getElementById('username');
    const balanceEl = document.getElementById('balance');
    const freeRoundsEl = document.getElementById('freeRounds');
    const betAmountInput = document.getElementById('betAmount');
    const depositInput = document.getElementById('depositAmount');
    const withdrawInput = document.getElementById('withdrawAmount');
    const betBtn = document.getElementById('betBtn');
    const cashOutBtn = document.getElementById('cashOutBtn');
    const statusEl = document.getElementById('status');

    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const depositBtn = document.getElementById('depositBtn');
    const withdrawBtn = document.getElementById('withdrawBtn');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const authForm = document.getElementById('authForm');
    const usernameRow = document.getElementById('usernameRow');
    const modalUsername = document.getElementById('modalUsername');
    const modalEmail = document.getElementById('modalEmail');
    const modalPassword = document.getElementById('modalPassword');
    const modalSubmit = document.getElementById('modalSubmit');
    const modalCancel = document.getElementById('modalCancel');
    const modalMessage = document.getElementById('modalMessage');

    /* ---------------------------
       Helpers: API calls
    */
    function authHeaders() {
      const t = localStorage.getItem('token') || null;
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    async function apiPost(path, body = {}, withAuth = true) {
      const headers = { 'Content-Type': 'application/json', ...(withAuth ? authHeaders() : {}) };
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers,
        body: JSON.stringify(body)
      });
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch (e) {}
      if (!res.ok) {
        const msg = (json && json.error) ? json.error : text || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return json;
    }

    async function apiGet(path, withAuth = true) {
      const headers = { ...(withAuth ? authHeaders() : {}) };
      const res = await fetch(API_BASE + path, { headers });
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch (e) {}
      if (!res.ok) {
        const msg = (json && json.error) ? json.error : text || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return json;
    }

    /* ---------------------------
       Auth: register / login / logout
    */
    function showModal(mode = 'login') {
      modalMessage.textContent = '';
      modalMessage.className = '';
      if (mode === 'login') {
        modalTitle.textContent = 'Login';
        usernameRow.style.display = 'none';
        modalUsername.value = '';
        modalEmail.value = '';
        modalPassword.value = '';
        modalSubmit.textContent = 'Login';
      } else {
        modalTitle.textContent = 'Register';
        usernameRow.style.display = '';
        modalUsername.value = '';
        modalEmail.value = '';
        modalPassword.value = '';
        modalSubmit.textContent = 'Register';
      }
      modalBackdrop.style.display = 'flex';
      modalEmail.focus();
    }

    function hideModal() {
      modalBackdrop.style.display = 'none';
    }

    modalCancel.addEventListener('click', (e) => {
      e.preventDefault();
      hideModal();
    });

    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      modalMessage.textContent = '';
      modalMessage.className = '';
      const isRegister = modalTitle.textContent.toLowerCase().includes('register');
      const email = modalEmail.value && modalEmail.value.trim();
      const password = modalPassword.value;
      const username = modalUsername.value && modalUsername.value.trim();

      if (!email || !password || (isRegister && !username)) {
        modalMessage.textContent = 'Please fill required fields';
        modalMessage.className = 'error';
        return;
      }

      modalSubmit.disabled = true;
      try {
        if (isRegister) {
          const body = { username, email, password };
          const json = await apiPost('/auth/register', body, false);
          if (json && json.token) {
            localStorage.setItem('token', json.token);
            token = json.token;
            currentUser = json.user;
            onLoggedIn(json.user);
            modalMessage.textContent = 'Registered and logged in';
            modalMessage.className = 'success';
            setTimeout(hideModal, 600);
          }
        } else {
          const body = { email, password };
          const json = await apiPost('/auth/login', body, false);
          if (json && json.token) {
            localStorage.setItem('token', json.token);
            token = json.token;
            currentUser = json.user;
            onLoggedIn(json.user);
            modalMessage.textContent = 'Logged in';
            modalMessage.className = 'success';
            setTimeout(hideModal, 400);
          }
        }
      } catch (err) {
        modalMessage.textContent = err.message || 'Auth failed';
        modalMessage.className = 'error';
      } finally {
        modalSubmit.disabled = false;
      }
    });

    registerBtn.addEventListener('click', () => showModal('register'));
    loginBtn.addEventListener('click', () => showModal('login'));
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      token = null;
      currentUser = null;
      onLoggedOut();
    });

    /* ---------------------------
       Wallet (deposit / withdraw)
    */
    depositBtn.addEventListener('click', async () => {
      const amount = Number(depositInput.value);
      if (!(amount > 0)) return alert('Enter deposit amount > 0');
      try {
        const updated = await apiPost('/users/deposit', { amount }, true);
        applyServerUser(updated);
        depositInput.value = '';
        alert('Deposit successful');
      } catch (err) {
        alert('Deposit failed: ' + (err.message || ''));
      }
    });

    withdrawBtn.addEventListener('click', async () => {
      const amount = Number(withdrawInput.value);
      if (!(amount > 0)) return alert('Enter withdraw amount > 0');
      try {
        const updated = await apiPost('/users/withdraw', { amount }, true);
        applyServerUser(updated);
        withdrawInput.value = '';
        alert('Withdraw successful');
      } catch (err) {
        alert('Withdraw failed: ' + (err.message || ''));
      }
    });

    /* ---------------------------
       Apply server user object to UI/state
    */
    function applyServerUser(user) {
      if (!user) return;
      currentUser = user;
      balance = Number(user.balance || 0);
      freePlays = Number(user.freeRounds || 0);
      usernameEl.textContent = user.username || user.email || 'Player';
      balanceEl.textContent = 'K ' + Number(balance).toFixed(2);
      freeRoundsEl.textContent = 'Free rounds: ' + freePlays;
      loginBtn.style.display = 'none';
      registerBtn.style.display = 'none';
      logoutBtn.style.display = '';
    }

    function onLoggedIn(user) {
      applyServerUser(user);
    }

    function onLoggedOut() {
      currentUser = null;
      balance = 0;
      freePlays = 0;
      usernameEl.textContent = 'Guest';
      balanceEl.textContent = 'K 0.00';
      freeRoundsEl.textContent = '';
      loginBtn.style.display = '';
      registerBtn.style.display = '';
      logoutBtn.style.display = 'none';
    }

    /* ---------------------------
       Initialize: if token present get /users/me
    */
    (async function init() {
      const t = localStorage.getItem('token');
      if (!t) { onLoggedOut(); return; }
      try {
        const me = await apiGet('/users/me', true);
        applyServerUser(me);
        token = t;
      } catch (err) {
        console.warn('Token invalid or network error', err);
        localStorage.removeItem('token');
        onLoggedOut();
      }
    })();

    /* ---------------------------
       Game logic (bets & persistence)
    */
    let multiplier = 1.0;
    let bet = 0;
    let timer = null;
    let crashed = false;

    function updateUI() {
      balanceEl.textContent = 'K ' + Number(balance || 0).toFixed(2);
      freeRoundsEl.textContent = freePlays ? 'Free rounds: ' + freePlays : '';
    }

    betBtn.addEventListener('click', async () => {
      if (timer) return;

      bet = Number(betAmountInput.value);
      if (bet <= 0) return alert('Enter a valid bet');

      let usingFree = false;
      if (freePlays > 0) {
        freePlays--;
        usingFree = true;
      } else {
        if (balance < bet) return alert('Insufficient balance');
        // persist deduction if logged in
        try {
          if (localStorage.getItem('token')) {
            const user = await apiPost('/users/balance/change', { delta: -bet }, true);
            applyServerUser(user);
          } else {
            balance -= bet; // local fallback
            updateUI();
          }
        } catch (err) {
          return alert('Could not place bet: ' + (err.message || ''));
        }
      }

      multiplier = 1.0;
      crashed = false;
      document.getElementById('plane').style.bottom = '10px';
      document.getElementById('multiplier').innerText = '1.00x';
      statusEl.textContent = '‚úàÔ∏è Plane taking off...';
      cashOutBtn.disabled = false;

      // LOSS-BIASED crash logic
      let crashPoint = Math.random() < 0.7 ? 1.1 + Math.random()*0.6 : 2 + Math.random()*3;

      timer = setInterval(()=> {
        multiplier += 0.02;
        document.getElementById('multiplier').innerText = multiplier.toFixed(2) + 'x';
        const planeEl = document.getElementById('plane');
        planeEl.style.bottom = (parseFloat(planeEl.style.bottom) + 2) + 'px';

        if (multiplier >= crashPoint) {
          crash();
        }
      }, 100);

      updateUI();
    });

    cashOutBtn.addEventListener('click', async () => {
      if (crashed) return;
      clearInterval(timer);
      timer = null;

      const win = bet * multiplier;
      balance += win;
      statusEl.textContent = '‚úÖ Cashed out at ' + multiplier.toFixed(2) + 'x ‚Üí Won K ' + win.toFixed(2);
      cashOutBtn.disabled = true;

      // persist win if logged in
      if (localStorage.getItem('token')) {
        try {
          const user = await apiPost('/users/balance/change', { delta: win }, true);
          applyServerUser(user);
        } catch (err) {
          console.error('Failed to persist win', err);
          alert('Warning: could not save your win to server.');
        }
      } else {
        updateUI(); // local fallback
      }
    });

    function crash() {
      clearInterval(timer);
      timer = null;
      crashed = true;
      statusEl.textContent = 'üí• CRASH at ' + multiplier.toFixed(2) + 'x ‚Äî You lost';
      cashOutBtn.disabled = true;
      updateUI();
    }

    /* ---------------------------
       Small UX: click outside modal closes it
    */
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) hideModal();
    });

    /* ---------------------------
       End
    */
  </script>
</body>
</html>